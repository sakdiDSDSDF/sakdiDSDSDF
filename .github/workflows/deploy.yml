# .github/workflows/deploy.yml

name: Deploy Documentation
on:
  # è§¦å‘æ¡ä»¶
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches:
      - main

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.10'
  DEPLOY_BRANCH: gh-pages

# ä»»åŠ¡å®šä¹‰
jobs:
  build:
    name: Build and Deploy Documentation
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„gitå†å²ç”¨äºæœ€è¿‘æ›´æ–°æ—¶é—´

      # è®¾ç½®Pythonç¯å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      # ç¼“å­˜ä¾èµ–
      - name: Cache Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # é…ç½®Git
      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      # æ„å»ºæ–‡æ¡£
      - name: Build Documentation
        run: |
          mkdocs build --clean --verbose

      # ä¼˜åŒ–èµ„æº
      - name: Optimize Assets
        run: |
          # å‹ç¼©å›¾ç‰‡
          find site/ -type f -name "*.png" -exec optipng -o5 {} \;
          find site/ -type f -name "*.jpg" -exec jpegoptim --strip-all {} \;

          # å‹ç¼©JavaScriptå’ŒCSS
          find site/ -type f -name "*.js" -exec uglifyjs {} -o {} \;
          find site/ -type f -name "*.css" -exec cleancss -o {} {} \;

      # éƒ¨ç½²åˆ°GitHub Pages
      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'  # åªåœ¨mainåˆ†æ”¯éƒ¨ç½²
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: ${{ env.DEPLOY_BRANCH }}
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: ${{ github.event.head_commit.message }}
          full_commit_message: |
            Deploy Documentation

            Commit: ${{ github.sha }}
            Workflow: ${{ github.workflow }}

            ${{ github.event.head_commit.message }}

      # éƒ¨ç½²å®Œæˆé€šçŸ¥
      - name: Deployment Status
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const run_id = context.runId;
            const run_url = `https://github.com/${owner}/${repo}/actions/runs/${run_id}`;

            if (context.job.status === 'success') {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.issue.number,
                body: `âœ… Documentation deployed successfully!\nPreview: https://${owner}.github.io/${repo}/\nWorkflow: ${run_url}`
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.issue.number,
                body: `âŒ Documentation deployment failed.\nSee details: ${run_url}`
              });
            }

# é”™è¯¯è¿½è¸ªå’ŒæŠ¥å‘Š
      - name: Report Errors
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const run_id = context.runId;

            await github.rest.issues.create({
              owner,
              repo,
              title: `ğŸ”´ Documentation deployment failed - ${new Date().toISOString()}`,
              body: `Deployment failed for commit: ${context.sha}\n\nSee workflow run: https://github.com/${owner}/${repo}/actions/runs/${run_id}\n\nPlease check the logs for more details.`,
              labels: ['deployment', 'bug']
            });